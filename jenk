pipeline{
    agent any
    stages {

        stage('git clone'){
            steps{

                git branch: 'main', url: 'https://github.com/vaibhav9191/kubernetes_java_deployment.git'
            }

           
        }

        
        
        stage('Build microservies Parallely'){
            parallel{

                stage('Build Microservice -1'){
                    steps{

                        sh 'cd shopfront && mvn clean install -Dskiptests'

                    }

                }
                stage('Build Microservice -2'){
                    steps{
                        sh 'cd productcatalogue && mvn clean install -Dskiptests'

                    }
                    
                }
                stage('Build Microservice -3'){

                    steps{
                        sh 'cd stockmanager && mvn clean install -Dskiptests'
                    }

                    
                }
                
            }

        }
        stage('static analysis'){

            steps{

                script{

                    withSonarQubeEnv(credentialsId: 'sonartok') {
                        sh 'cd shopfront && mvn clean package sonar:sonar -Dsonar.projectKey=shopfront -Dsonar.projectName=shopfront'
                        sh 'cd productcatalogue && mvn clean package sonar:sonar -Dsonar.projectKey=productcatalogue -Dsonar.projectName=productcatalogue'
                        sh 'cd stockmanager && mvn clean package sonar:sonar -Dsonar.projectKey=stockmanager -Dsonar.projectName=stockmanager'


                    }

                }

                

                

            }
        }

        stage('Quality gate status'){

            steps{
                script{
                    

                     def microservices = ['shopfront', 'productcatalogue', 'stockmanager']
            
                      for (def service : microservices) {
            
                        echo "Checking quality gate for ${service}"
                
                        waitForQualityGate abortPipeline: false, credentialsId: 'nwwsonar', serviceKey: service
              

                    // def services = ['shopfront','productcatalogue','stockmanager']
                    // def sonarUrl = 'http://3.84.23.127:9000'
                    // def sonarToken = credentials('sonartok')
                    // for (service in services){
                    //     def result = sh(script: "curl -s -u ${sonarToken} ${sonarUrl}/api/qualitygates/project_status?project=${service}", returnStdout: true)


                    }
                    



                    // def qualityGate = qualityGateCheck()
                    // for(service in services){
                    //     def result = qualityGate.getQualitygeteResult(projectKey: service)
                    //     echo "Quality Gate status For ${service} : ${result.getStatus()}"
                    //     if(result.isFailed()){
                    //         currentBuild.result = 'FAILURE'
                    //         //dd
                    //     }
                    //} 


                }
            }



        }

    }
}